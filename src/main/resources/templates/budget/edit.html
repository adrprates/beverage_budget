<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Editar Orçamento</title>
    <link rel="stylesheet" th:href="@{/budget/save.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container py-5">
    <div class="card">
        <h2 class="card-title mb-4 text-center">Editar Orçamento</h2>

        <form th:action="@{/budget/save}" method="post">
            <input type="hidden" th:name="id" th:value="${budget.id}">

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="name" class="form-label">Nome do orçamento</label>
                    <input type="text" id="name" name="name" class="form-control" th:value="${budget.name}" required>
                </div>
                <div class="col-md-3">
                    <label for="peopleCount" class="form-label">Qtd. de pessoas</label>
                    <input type="number" id="peopleCount" name="peopleCount" class="form-control" th:value="${budget.peopleCount}" required>
                </div>
                <div class="col-md-3">
                    <label for="markupPercentage" class="form-label">Markup (%)</label>
                    <input type="number" id="markupPercentage" name="markupPercentage" step="0.01" class="form-control" th:value="${budget.markupPercentage}">
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <label for="eventDate" class="form-label">Data do evento</label>
                    <input type="date" id="eventDate" name="eventDate" class="form-control" th:value="${budget.eventDate}">
                </div>
                <div class="col-md-6">
                    <label for="eventHour" class="form-label">Hora do evento</label>
                    <input type="time" id="eventHour" name="eventHour" class="form-control" th:value="${budget.eventHour}">
                </div>
            </div>

            <hr>

            <h5 class="mb-3">Drinks</h5>
            <div class="row mb-3 align-items-center">
                <div class="col-md-6">
                    <select id="drinkSelect" class="form-select">
                        <option value="">Selecione um drink</option>
                        <option th:each="d : ${allDrinks}" th:value="${d.id}" th:text="${d.name}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" id="drinkQuantity" placeholder="Qtd." class="form-control">
                </div>
                <div class="col-md-3">
                    <button type="button" id="addDrinkBtn" class="btn btn-primary w-100">Adicionar</button>
                </div>
            </div>

           <div id="addedDrinks">
                <div th:each="d : ${selectedDrinks}" class="added-item" 
                    style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">

                    <span th:text="${d.drinkName}" style="white-space: nowrap;"></span>
                    <input type="number" class="drink-quantity" 
                          style="width: 100px; padding: 2px; font-size: 0.9rem;" 
                          min="1" th:value="${d.quantity}">
                    <span style="font-size: 0.9rem;">un</span>

                    <button class="btn-remove btn btn-sm btn-danger" type="button" 
                            style="margin-left: auto;">Remover</button>

                    <input type="hidden" name="drinkIds" th:value="${d.drinkId}">
                    <input type="hidden" name="drinkQuantities" th:value="${d.quantity}">
                </div>
            </div>

            <hr>

            <h5 class="mb-3">Ingredientes dos Drinks Selecionados</h5>
            <button type="button" id="restoreProportionBtn" class="btn btn-secondary btn-sm mb-2">Restaurar Proporção</button>

            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Ingrediente</th>
                        <th>Quantidade</th>
                        <th>Unidade(s)</th>
                        <th>Valor Unit.</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="autoIngredientsTable">
                    <tr th:each="ai : ${autoIngredients}">
                        <td th:text="${ai.ingredientName}"></td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <input class="form-control form-control-sm final-quantity" type="number" min="0" step="0.01" th:value="${ai.quantity}">
                                <span style="margin-left: 4px;" th:text="${ai.unitMeasure}"></span>
                            </div>
                            <input type="hidden" name="autoIngredientIds" th:value="${ai.ingredientId}">
                        </td>
                        <td>
                            <input class="form-control form-control-sm units" type="number" min="0" step="1" th:value="${ai.unitsNeeded}">
                            <input type="hidden" name="autoIngredientUnits" th:value="${ai.unitsNeeded}">
                        </td>
                        <td>
                            <input class="form-control form-control-sm unit-price" type="number" min="0" step="0.01" th:value="${ai.unitPrice}">
                            <input type="hidden" name="autoIngredientUnitPrices" th:value="${ai.unitPrice}">
                        </td>
                        <td>
                            <span class="total-display" data-value="${ai.totalPrice}">0,00</span>
                            <input type="hidden" class="total" th:value="${ai.totalPrice}">
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="4" class="text-end">Subtotal Ingredientes de Drinks</th>
                        <th id="autoIngredientsSubtotal">0,00</th>
                    </tr>
                </tfoot>
            </table>

            <hr>

            <h5 class="mb-3">Ingredientes Manuais</h5>
            <div class="row mb-3 align-items-center">
                <div class="col-md-4">
                    <select id="manualIngredientSelect" class="form-select">
                        <option value="">Selecione o ingrediente</option>
                        <option th:each="i : ${allIngredients}" th:value="${i.id}" th:text="${i.name}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" id="manualIngredientQuantity" placeholder="Qtd." class="form-control">
                </div>
                <div class="col-md-3">
                    <input type="number" id="manualIngredientUnitPrice" placeholder="Preço Unit." class="form-control">
                </div>
                <div class="col-md-2">
                    <button type="button" id="addManualIngredientBtn" class="btn btn-primary w-100">Adicionar</button>
                </div>
            </div>

            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Ingrediente</th>
                        <th>Quantidade</th>
                        <th>Unidades</th>
                        <th>Valor Unit.</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="manualIngredientsTable">
                    <tr th:each="mi : ${manualIngredients}">
                        <td th:text="${mi.ingredientName}"></td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <input class="form-control form-control-sm final-quantity" type="number" min="0" step="0.01" th:value="${mi.quantity}">
                                <span style="margin-left: 4px;" th:text="${mi.unitMeasure}"></span>
                            </div>
                            <input type="hidden" name="manualIngredientIds" th:value="${mi.ingredientId}">
                        </td>
                        <td>
                            <input class="form-control form-control-sm units" type="number" min="0" step="1" th:value="${mi.unitsNeeded}">
                            <input type="hidden" name="manualIngredientUnits" th:value="${mi.unitsNeeded}">
                        </td>
                        <td>
                            <input class="form-control form-control-sm unit-price" type="number" min="0" step="0.01" th:value="${mi.unitPrice}">
                            <input type="hidden" name="manualIngredientUnitPrices" th:value="${mi.unitPrice}">
                        </td>
                        <td>
                            <span class="total-display" data-value="${mi.totalPrice}">0,00</span>
                            <input type="hidden" class="total" th:value="${mi.totalPrice}">
                        </td>
                        <td>
                            <button class="btn-remove btn btn-sm btn-danger" type="button">Remover</button>
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="4" class="text-end">Subtotal Ingredientes Manuais</th>
                        <th id="manualIngredientsSubtotal">0,00</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>

            <hr>

            <h5 class="mb-3">Recursos</h5>
            <div class="row g-2 mb-3">
                <div class="col-md-4">
                    <label class="form-label">Recurso</label>
                    <select id="resourceSelect" class="form-select">
                        <option value="">Selecione um recurso</option>
                        <option th:each="r : ${allResources}" th:value="${r.id}" th:text="${r.name}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Quantidade</label>
                    <input id="resourceQuantity" type="number" min="0" step="0.01" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Valor Unitário (R$)</label>
                    <input id="resourceUnitPrice" type="number" min="0" step="0.01" class="form-control">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button id="addResourceBtn" type="button" class="btn btn-primary w-100">Adicionar</button>
                </div>
            </div>

            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Recurso</th>
                        <th>Quantidade</th>
                        <th>Valor Unit.</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="resourcesTable">
                    <tr th:each="r : ${resources}">
                        <td th:text="${r.resourceName}"></td>
                        <td>
                            <input class="form-control form-control-sm quantity" type="number" min="0" step="0.01" th:value="${r.quantity}">
                            <input type="hidden" name="resourceIds" th:value="${r.resourceId}">
                        </td>
                        <td>
                            <input class="form-control form-control-sm unit-price" type="number" min="0" step="0.01" th:value="${r.unitPrice}">
                            <input type="hidden" name="resourceUnitPrices" th:value="${r.unitPrice}">
                        </td>
                        <td>
                            <span class="total-display" data-value="${r.totalPrice}">0,00</span>
                            <input type="hidden" class="total" th:value="${r.totalPrice}">
                        </td>
                        <td>
                            <button class="btn-remove btn btn-sm btn-danger" type="button">Remover</button>
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3" class="text-end">Subtotal Recursos</th>
                        <th id="resourceSubtotal">0,00</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>

            <hr>

            <div class="text-end mb-4">
                <h4>Total Custo: <span id="totalCostDisplay">0,00</span></h4>
                <h4 class="text-success">Preço Final: <span id="finalPriceDisplay">0,00</span></h4>
                <div class="mt-2">
                    <label for="customFinalPrice" class="form-label">Valor personalizado (opcional)</label>
                    <input type="number" id="customFinalPrice" name="customFinalPrice" step="0.01"
                           class="form-control w-auto d-inline-block text-end"
                           th:value="${budget.customFinalPrice != null ? budget.customFinalPrice : ''}"
                           placeholder="R$">
                </div>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-primary px-5">Salvar Orçamento</button>
                <a th:href="@{/budget/list}" class="btn btn-secondary px-5">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function formatBRL(value) {
        return (value || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    let selectedDrinks = [];

    document.querySelectorAll('.added-item').forEach(item => {
        const qtyInput = item.querySelector('input[type="number"]');
        const hiddenQty = item.querySelector('input[name="drinkQuantities"]');

        qtyInput.addEventListener('input', () => {
            hiddenQty.value = qtyInput.value;
            updateTotals();
        });
    });
    function updateTotals() {
        let autoSubtotal = 0;
        document.querySelectorAll('#autoIngredientsTable tr').forEach(tr => {
            const qty = parseFloat(tr.querySelector('.final-quantity').value) || 0;
            const unitPrice = parseFloat(tr.querySelector('.unit-price').value) || 0;
            const total = qty * unitPrice;
            tr.querySelector('.total-display').textContent = formatBRL(total);
            tr.querySelector('.total').value = total;
            autoSubtotal += total;
        });
        document.getElementById('autoIngredientsSubtotal').textContent = formatBRL(autoSubtotal);

        let manualSubtotal = 0;
        document.querySelectorAll('#manualIngredientsTable tr').forEach(tr => {
            const qty = parseFloat(tr.querySelector('.final-quantity').value) || 0;
            const unitPrice = parseFloat(tr.querySelector('.unit-price').value) || 0;
            const total = qty * unitPrice;
            tr.querySelector('.total-display').textContent = formatBRL(total);
            tr.querySelector('.total').value = total;
            manualSubtotal += total;
        });
        document.getElementById('manualIngredientsSubtotal').textContent = formatBRL(manualSubtotal);

        let resourceSubtotal = 0;
        document.querySelectorAll('#resourcesTable tr').forEach(tr => {
            const qty = parseFloat(tr.querySelector('.quantity').value) || 0;
            const unitPrice = parseFloat(tr.querySelector('.unit-price').value) || 0;
            const total = qty * unitPrice;
            tr.querySelector('.total-display').textContent = formatBRL(total);
            tr.querySelector('.total').value = total;
            resourceSubtotal += total;
        });
        document.getElementById('resourceSubtotal').textContent = formatBRL(resourceSubtotal);

        const markup = parseFloat(document.getElementById('markupPercentage').value) || 0;
        const totalCost = autoSubtotal + manualSubtotal + resourceSubtotal;
        const markupValue = totalCost * (markup / 100);
        const finalTotal = totalCost + markupValue;

        document.getElementById('totalCostDisplay').textContent = formatBRL(finalTotal);

        const custom = parseFloat(document.getElementById('customFinalPrice').value);
        document.getElementById('finalPriceDisplay').textContent = isNaN(custom) ? formatBRL(finalTotal) : formatBRL(custom);
    }

    document.addEventListener('input', updateTotals);
    updateTotals();
</script>

</body>
</html>