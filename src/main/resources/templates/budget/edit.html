<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Editar Orçamento</title>
    <link rel="stylesheet" th:href="@{/budget/save.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-expand-lg bg-white border-bottom">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/}">Prates Bar</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="menu">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" th:href="@{/ingredient}">Ingredientes</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/drink}">Drinks</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/resource}">Recursos</a></li>
                <li class="nav-item"><a class="nav-link active" th:href="@{/budget}">Orçamentos</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container py-5">
    <div class="card">
        <h2 class="card-title mb-4 text-center">Editar Orçamento</h2>

        <form th:action="@{/budget/save}" method="post">
            <input type="hidden" th:name="id" th:value="${budget.id}">

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="name" class="form-label">Nome do orçamento</label>
                    <input type="text" id="name" name="name" class="form-control" th:value="${budget.name}" required>
                </div>
                <div class="col-md-3">
                    <label for="peopleCount" class="form-label">Qtd. de pessoas</label>
                    <input type="number" id="peopleCount" name="peopleCount" class="form-control" th:value="${budget.peopleCount}" required>
                </div>
                <div class="col-md-3">
                    <label for="markupPercentage" class="form-label">Markup (%)</label>
                    <input type="number" id="markupPercentage" name="markupPercentage" step="0.01" class="form-control" th:value="${budget.markupPercentage}">
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <label for="eventDate" class="form-label">Data do evento</label>
                    <input type="date" id="eventDate" name="eventDate" class="form-control" th:value="${budget.eventDate}">
                </div>
                <div class="col-md-6">
                    <label for="eventHour" class="form-label">Hora do evento</label>
                    <input type="time" id="eventHour" name="eventHour" class="form-control" th:value="${budget.eventHour}">
                </div>
            </div>

            <hr>

            <h5 class="mb-3">Drinks</h5>
            <div class="row mb-3 align-items-center">
                <div class="col-md-6">
                    <select id="drinkSelect" class="form-select">
                        <option value="">Selecione um drink</option>
                        <option th:each="d : ${allDrinks}" th:value="${d.id}" th:text="${d.name}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" id="drinkQuantity" placeholder="Qtd." class="form-control">
                </div>
                <div class="col-md-3">
                    <button type="button" id="addDrinkBtn" class="btn btn-primary w-100">Adicionar</button>
                </div>
            </div>

           <div id="addedDrinks">
                <div th:each="d : ${selectedDrinks}" class="added-item" 
                    style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">

                    <span th:text="${d.drinkName}" style="white-space: nowrap;"></span>
                    <input type="number" class="drink-quantity" 
                          style="width: 100px; padding: 2px; font-size: 0.9rem;" 
                          min="1" th:value="${d.quantity}">
                    <span style="font-size: 0.9rem;">un</span>

                    <button class="btn-remove btn btn-sm btn-danger" type="button" 
                            style="margin-left: auto;">Remover</button>

                    <input type="hidden" name="drinkIds" th:value="${d.drinkId}">
                    <input type="hidden" name="drinkQuantities" th:value="${d.quantity}">
                </div>
            </div>

            <hr>

            <h5 class="mb-3">Ingredientes dos Drinks Selecionados</h5>
            <button type="button" id="restoreProportionBtn" class="btn btn-secondary btn-sm mb-2">Restaurar Proporção</button>

            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Ingrediente</th>
                        <th>Quantidade</th>
                        <th>Unidade(s)</th>
                        <th>Valor Unit.</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="autoIngredientsTable">
                    <tr th:each="ai : ${autoIngredients}">
                        <td th:text="${ai.ingredientName}"></td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <input class="form-control form-control-sm final-quantity" type="number" min="0" step="0.01" th:value="${ai.quantity}">
                                <span style="margin-left: 4px;" th:text="${ai.unitMeasure}"></span>
                            </div>
                            <input type="hidden" name="autoIngredientIds" th:value="${ai.ingredientId}">
                        </td>
                        <td>
                            <input class="form-control form-control-sm units" type="number" min="0" step="1" th:value="${ai.unitsNeeded}">
                            <input type="hidden" name="autoIngredientUnits" th:value="${ai.unitsNeeded}">
                        </td>
                        <td>
                            <input class="form-control form-control-sm unit-price" type="number" min="0" step="0.01" th:value="${ai.unitPrice}">
                            <input type="hidden" name="autoIngredientUnitPrices" th:value="${ai.unitPrice}">
                        </td>
                        <td>
                            <span class="total-display" data-value="${ai.totalPrice}">0,00</span>
                            <input type="hidden" class="total" th:value="${ai.totalPrice}">
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="4" class="text-end">Subtotal Ingredientes de Drinks</th>
                        <th id="autoIngredientsSubtotal">0,00</th>
                    </tr>
                </tfoot>
            </table>

            <hr>

            <h5 class="mb-3">Ingredientes Manuais</h5>
            <div class="row mb-3 align-items-center">
                <div class="col-md-4">
                    <select id="manualIngredientSelect" class="form-select">
                        <option value="">Selecione o ingrediente</option>
                        <option th:each="i : ${allIngredients}" th:value="${i.id}" th:text="${i.name}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" id="manualIngredientQuantity" placeholder="Qtd." class="form-control">
                </div>
                <div class="col-md-3">
                    <input type="number" id="manualIngredientUnitPrice" placeholder="Preço Unit." class="form-control">
                </div>
                <div class="col-md-2">
                    <button type="button" id="addManualIngredientBtn" class="btn btn-primary w-100">Adicionar</button>
                </div>
            </div>

            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Ingrediente</th>
                        <th>Quantidade</th>
                        <th>Unidades</th>
                        <th>Valor Unit.</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="manualIngredientsTable">
                    <tr th:each="mi : ${manualIngredients}">
                        <td th:text="${mi.ingredientName}"></td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <input class="form-control form-control-sm final-quantity" type="number" min="0" step="0.01" th:value="${mi.quantity}">
                                <span style="margin-left: 4px;" th:text="${mi.unitMeasure}"></span>
                            </div>
                            <input type="hidden" name="manualIngredientIds" th:value="${mi.ingredientId}">
                        </td>
                        <td>
                            <input class="form-control form-control-sm units" type="number" min="0" step="1" th:value="${mi.unitsNeeded}">
                            <input type="hidden" name="manualIngredientUnits" th:value="${mi.unitsNeeded}">
                        </td>
                        <td>
                            <input class="form-control form-control-sm unit-price" type="number" min="0" step="0.01" th:value="${mi.unitPrice}">
                            <input type="hidden" name="manualIngredientUnitPrices" th:value="${mi.unitPrice}">
                        </td>
                        <td>
                            <span class="total-display" data-value="${mi.totalPrice}">0,00</span>
                            <input type="hidden" class="total" th:value="${mi.totalPrice}">
                        </td>
                        <td>
                            <button class="btn-remove btn btn-sm btn-danger" type="button">Remover</button>
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="4" class="text-end">Subtotal Ingredientes Manuais</th>
                        <th id="manualIngredientsSubtotal">0,00</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>

            <hr>

            <h5 class="mb-3">Recursos</h5>
            <div class="row g-2 mb-3">
                <div class="col-md-4">
                    <label class="form-label">Recurso</label>
                    <select id="resourceSelect" class="form-select">
                        <option value="">Selecione um recurso</option>
                        <option th:each="r : ${allResources}" th:value="${r.id}" th:text="${r.name}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Quantidade</label>
                    <input id="resourceQuantity" type="number" min="0" step="0.01" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Valor Unitário (R$)</label>
                    <input id="resourceUnitPrice" type="number" min="0" step="0.01" class="form-control">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button id="addResourceBtn" type="button" class="btn btn-primary w-100">Adicionar</button>
                </div>
            </div>

            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Recurso</th>
                        <th>Quantidade</th>
                        <th>Valor Unit.</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="resourcesTable">
                    <tr th:each="r : ${resources}">
                        <td th:text="${r.resourceName}"></td>
                        <td>
                            <input class="form-control form-control-sm quantity" type="number" min="0" step="0.01" th:value="${r.quantity}">
                            <input type="hidden" name="resourceIds" th:value="${r.resourceId}">
                        </td>
                        <td>
                            <input class="form-control form-control-sm unit-price" type="number" min="0" step="0.01" th:value="${r.unitPrice}">
                            <input type="hidden" name="resourceUnitPrices" th:value="${r.unitPrice}">
                        </td>
                        <td>
                            <span class="total-display" data-value="${r.totalPrice}">0,00</span>
                            <input type="hidden" class="total" th:value="${r.totalPrice}">
                        </td>
                        <td>
                            <button class="btn-remove btn btn-sm btn-danger" type="button">Remover</button>
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3" class="text-end">Subtotal Recursos</th>
                        <th id="resourceSubtotal">0,00</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>

            <hr>

            <div class="text-end mb-4">
                <h4>Total Custo: <span id="totalCostDisplay">0,00</span></h4>
                <h4 class="text-success">Preço Final: <span id="finalPriceDisplay">0,00</span></h4>
                <div class="mt-2">
                    <label for="customFinalPrice" class="form-label">Valor personalizado (opcional)</label>
                    <input type="number" id="customFinalPrice" name="customFinalPrice" step="0.01"
                           class="form-control w-auto d-inline-block text-end"
                           th:value="${budget.customFinalPrice != null ? budget.customFinalPrice : ''}"
                           placeholder="R$">
                </div>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-primary px-5">Salvar Orçamento</button>
                <a th:href="@{/budget}" class="btn btn-secondary px-5">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
function formatBRL(value) {
    return (value || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function setCurrencyText(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    el.innerText = value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

function sumTableTotals(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return 0;
    let total = 0;
    table.querySelectorAll('.total').forEach(inp => {
        total += parseFloat(inp.value || 0);
    });
    return total;
}

function updateAllTotals() {
    const autoTotal = sumTableTotals('autoIngredientsTable');
    const manualTotal = sumTableTotals('manualIngredientsTable');
    const resourceTotal = sumTableTotals('resourcesTable');

    setCurrencyText('autoIngredientsSubtotal', autoTotal);
    setCurrencyText('manualIngredientsSubtotal', manualTotal);
    setCurrencyText('resourceSubtotal', resourceTotal);

    setCurrencyText('autoIngredientsSubtotalDisplay', autoTotal);
    setCurrencyText('manualIngredientsSubtotalDisplay', manualTotal);
    setCurrencyText('resourceSubtotalDisplay', resourceTotal);

    const ingredientsTotal = autoTotal + manualTotal;
    const markupPercent = parseFloat(document.getElementById('markupPercentage')?.value || 0);
    const markupValue = (ingredientsTotal + resourceTotal) * (markupPercent / 100);
    setCurrencyText('markupValueDisplay', markupValue);

    const totalCost = ingredientsTotal + resourceTotal + markupValue;
    setCurrencyText('totalCostDisplay', totalCost);

    const custom = parseFloat(document.getElementById('customFinalPrice')?.value || 0);
    setCurrencyText('finalPriceDisplay', custom > 0 ? custom : totalCost);
}

function findNamed(row, baseName) {
    return row.querySelector(`[name^="${baseName}"]`);
}
function findAllNamed(documentRoot, baseName) {
    return [...(documentRoot.querySelectorAll(`[name^="${baseName}"]`) || [])];
}

function syncRowHiddenFields(row) {
    const qtyVisible = row.querySelector('.final-quantity, .quantity');
    if (qtyVisible) {
        const hiddenFinal = row.querySelector('.hidden-final-quantity') || findNamed(row, 'autoIngredientQuantities') || findNamed(row, 'manualIngredientQuantities') || findNamed(row, 'resourceQuantities');
        if (hiddenFinal) hiddenFinal.value = qtyVisible.value || 0;
    }

    const unitsVisible = row.querySelector('.units');
    if (unitsVisible) {
        const hiddenUnits = row.querySelector('.hidden-units') || findNamed(row, 'autoIngredientUnits') || findNamed(row, 'manualIngredientUnits');
        if (hiddenUnits) hiddenUnits.value = unitsVisible.value || 0;
    }

    const unitPriceVisible = row.querySelector('.unit-price');
    if (unitPriceVisible) {
        const hiddenUnitPrice = row.querySelector('.hidden-unit-price') || findNamed(row, 'autoIngredientUnitPrices') || findNamed(row, 'manualIngredientUnitPrices') || findNamed(row, 'resourceUnitPrices');
        if (hiddenUnitPrice) hiddenUnitPrice.value = unitPriceVisible.value || 0;
    }

    const totalHidden = row.querySelector('.total');
    if (totalHidden) {
        totalHidden.value = parseFloat(totalHidden.value || 0);
    }
    const namedTotal = findNamed(row, 'resourceTotals') || findNamed(row, 'autoIngredientTotals') || findNamed(row, 'manualIngredientTotals');
    if (namedTotal && totalHidden) {
        namedTotal.value = totalHidden.value;
    }
}

function updateRowDisplay(row) {
    const qtyInput = row.querySelector('.final-quantity, .quantity');
    const unitPriceInput = row.querySelector('.unit-price');
    const unitsInput = row.querySelector('.units');

    const unitPrice = parseFloat(unitPriceInput?.value || 0);

    const isAutoRow = !!row.querySelector('[name^="autoIngredientIds"]');
    const isManualRow = !!row.querySelector('[name^="manualIngredientIds"]');
    const isResourceRow = !!row.querySelector('[name^="resourceIds"]');

    let total = 0;

    if (isResourceRow) {
        const qty = parseFloat(qtyInput?.value || 0);
        total = qty * unitPrice;
    } else if (isAutoRow || isManualRow) {
        const units = parseFloat(unitsInput?.value || 0);
        total = units * unitPrice;
    }

    const totalDisplay = row.querySelector('.total-display');
    if (totalDisplay) totalDisplay.textContent = formatBRL(total);

    const totalHidden = row.querySelector('.total');
    if (totalHidden) totalHidden.value = total;

    syncRowHiddenFields(row);

    updateAllTotals();
}


function setupExistingRows(tableId, isAuto = false) {
    const table = document.getElementById(tableId);
    if (!table) return;

    table.querySelectorAll('tbody tr, #'+tableId+' > tr, #'+tableId+' tr').forEach(row => {
        const qtyInput = row.querySelector('.final-quantity, .quantity');
        const unitsInput = row.querySelector('.units');
        const unitPriceInput = row.querySelector('.unit-price');
        const removeBtn = row.querySelector('.btn-remove');

        const isAutoRow = !!row.querySelector('[name^="autoIngredientIds"]');
        const isManualRow = !!row.querySelector('[name^="manualIngredientIds"]');
        const isResourceRow = !!row.querySelector('[name^="resourceIds"]');

        if (!qtyInput && !unitPriceInput && !unitsInput) return;
        if (!isAutoRow && !isManualRow && !isResourceRow) return;

        if (qtyInput) {
            qtyInput.addEventListener('input', () => {
                syncRowHiddenFields(row);
                updateRowDisplay(row);
            });
            if (isAuto && isAutoRow) {
                qtyInput.addEventListener('blur', async () => {
                    const idEl = row.querySelector('[name^="autoIngredientIds"]');
                    if (!idEl) return;
                    const ingredientId = Number(idEl.value);
                    const drinksPayload = [...document.getElementsByName('drinkIds')].map((el, idx) => ({
                        drinkId: el.value,
                        quantity: parseFloat(document.getElementsByName('drinkQuantities')[idx]?.value || 0)
                    }));
                    const payload = { ingredientId, quantity: parseFloat(qtyInput.value || 0), drinks: drinksPayload };
                    try {
                        const res = await fetch('/drink/update-quantity', {
                            method: 'POST',
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if (!data.error) {
                            qtyInput.value = parseFloat(data.quantity).toFixed(2);
                            if (unitsInput) {
                                unitsInput.value = data.units;
                                const hiddenUnits = row.querySelector('.hidden-units') || row.querySelector('[name^="autoIngredientUnits"]');
                                if (hiddenUnits) hiddenUnits.value = data.units;
                            }
                            const hiddenFinalQty = row.querySelector('.hidden-final-quantity') || row.querySelector('[name^="autoIngredientQuantities"]');
                            if (hiddenFinalQty) hiddenFinalQty.value = data.quantity;
                            updateRowDisplay(row);
                        }
                    } catch (e) {
                        console.error('Erro update-quantity:', e);
                    }
                });
            }
            if (isManualRow) {
                qtyInput.addEventListener('blur', async () => {
                    const idEl = row.querySelector('[name^="manualIngredientIds"]');
                    if (!idEl) return;
                    const manualIngredientId = Number(idEl.value);
                    const payload = { ingredientId: manualIngredientId, quantity: parseFloat(qtyInput.value || 0), unitPrice: parseFloat(row.querySelector('.unit-price')?.value || 0) };
                    try {
                        const res = await fetch('/budget/manual-ingredient/calculate', {
                            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        qtyInput.value = parseFloat(data.quantity).toFixed(2);
                        if (unitsInput) unitsInput.value = data.unitsNeeded;
                        const totalHidden = row.querySelector('.total');
                        if (totalHidden) totalHidden.value = parseFloat(data.totalPrice || 0);
                        const totalDisplay = row.querySelector('.total-display');
                        if (totalDisplay) totalDisplay.innerText = formatBRL(parseFloat(data.totalPrice || 0));
                        const hiddenFinal = row.querySelector('.hidden-final-quantity') || row.querySelector('[name^="manualIngredientQuantities"]');
                        if (hiddenFinal) hiddenFinal.value = data.quantity;
                        const hiddenUnits = row.querySelector('.hidden-units') || row.querySelector('[name^="manualIngredientUnits"]');
                        if (hiddenUnits) hiddenUnits.value = data.unitsNeeded;
                        updateAllTotals();
                    } catch (e) {
                        console.error('Erro manual quantity calc:', e);
                    }
                });
            }
        }

        if (unitsInput) {
            unitsInput.addEventListener('input', () => {
                syncRowHiddenFields(row);
                updateRowDisplay(row);
            });
            if (isAuto && isAutoRow) {
                unitsInput.addEventListener('blur', async () => {
                    const idEl = row.querySelector('[name^="autoIngredientIds"]');
                    if (!idEl) return;
                    const ingredientId = Number(idEl.value);
                    const drinksPayload = [...document.getElementsByName('drinkIds')].map((el, idx) => ({
                        drinkId: el.value,
                        quantity: parseFloat(document.getElementsByName('drinkQuantities')[idx]?.value || 0)
                    }));
                    const payload = { ingredientId, units: parseInt(unitsInput.value || 0), drinks: drinksPayload };
                    try {
                        const res = await fetch('/drink/update-units', {
                            method: 'POST',
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if (!data.error) {
                            const qtyEl = row.querySelector('.final-quantity, .quantity');
                            if (qtyEl) qtyEl.value = parseFloat(data.quantity).toFixed(2);
                            unitsInput.value = data.units;
                            const hiddenFinalQty = row.querySelector('.hidden-final-quantity') || row.querySelector('[name^="autoIngredientQuantities"]');
                            if (hiddenFinalQty) hiddenFinalQty.value = data.quantity;
                            updateRowDisplay(row);
                        }
                    } catch (e) {
                        console.error('Erro update-units:', e);
                    }
                });
            }
            if (isManualRow) {
                unitsInput.addEventListener('blur', async () => {
                    const idEl = row.querySelector('[name^="manualIngredientIds"]');
                    if (!idEl) return;
                    const manualIngredientId = Number(idEl.value);
                    const payload = { ingredientId: manualIngredientId, units: parseInt(unitsInput.value || 0), unitPrice: parseFloat(row.querySelector('.unit-price')?.value || 0) };
                    try {
                        const res = await fetch('/budget/manual-ingredient/calculate', {
                            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        const qtyEl = row.querySelector('.final-quantity, .quantity');
                        if (qtyEl) qtyEl.value = parseFloat(data.quantity).toFixed(2);
                        const totalHidden = row.querySelector('.total');
                        if (totalHidden) totalHidden.value = parseFloat(data.totalPrice || 0);
                        const totalDisplay = row.querySelector('.total-display');
                        if (totalDisplay) totalDisplay.innerText = formatBRL(parseFloat(data.totalPrice || 0));
                        const hiddenFinal = row.querySelector('.hidden-final-quantity') || row.querySelector('[name^="manualIngredientQuantities"]');
                        if (hiddenFinal) hiddenFinal.value = data.quantity;
                        const hiddenUnits = row.querySelector('.hidden-units') || row.querySelector('[name^="manualIngredientUnits"]');
                        if (hiddenUnits) hiddenUnits.value = data.unitsNeeded;
                        updateAllTotals();
                    } catch (e) {
                        console.error('Erro manual units calc:', e);
                    }
                });
            }
        }

        if (unitPriceInput) {
            unitPriceInput.addEventListener('input', () => {
                syncRowHiddenFields(row);
                updateRowDisplay(row);
            });
        }

        if (removeBtn) {
            removeBtn.addEventListener('click', () => {
                row.remove();
                updateAllTotals();
            });
        }

        [
        'autoIngredientIds','autoIngredientQuantities','autoIngredientUnitPrices','autoIngredientUnits',
        'manualIngredientIds','manualIngredientQuantities','manualIngredientUnitPrices','manualIngredientUnits',
        'manualIngredientTotals',
        'resourceIds','resourceQuantities','resourceUnitPrices','resourceTotals'
        ].forEach(nameBase => {

            if (!row.querySelector(`[name^="${nameBase}"]`)) {

                if (nameBase.startsWith('auto') && isAutoRow) {
                    const hidden = document.createElement('input');
                    hidden.type = 'hidden';
                    hidden.name = nameBase;

                    if (nameBase.includes('Id')) {
                        const existingId =
                            row.dataset.ingredientId ||
                            row.querySelector('[data-ingredient-id]')?.dataset?.ingredientId;
                        if (existingId) hidden.value = existingId;

                    } else if (nameBase.includes('Quantity')) {
                        hidden.value = row.querySelector('.final-quantity')?.value || 0;
                        hidden.className = 'hidden-final-quantity';

                    } else if (nameBase.includes('UnitPrice')) {
                        hidden.value = row.querySelector('.unit-price')?.value || 0;
                        hidden.className = 'hidden-unit-price';

                    } else if (nameBase.includes('Units')) {
                        hidden.value = row.querySelector('.units')?.value || 0;
                        hidden.className = 'hidden-units';

                    } else if (nameBase.includes('Total')) {
                        hidden.value = row.querySelector('.total')?.value || 0;
                        hidden.className = 'hidden-total-price';
                    }

                    row.appendChild(hidden);
                }

                else if (nameBase.startsWith('manual') && isManualRow) {
                    const hidden = document.createElement('input');
                    hidden.type = 'hidden';
                    hidden.name = nameBase;

                    if (nameBase.includes('Quantity')) {
                        hidden.value = row.querySelector('.final-quantity')?.value || 0;
                        hidden.className = 'hidden-final-quantity';

                    } else if (nameBase.includes('UnitPrice')) {
                        hidden.value = row.querySelector('.unit-price')?.value || 0;
                        hidden.className = 'hidden-unit-price';

                    } else if (nameBase.includes('Units')) {
                        hidden.value = row.querySelector('.units')?.value || 0;
                        hidden.className = 'hidden-units';

                    } else if (nameBase.includes('Total')) {
                        hidden.value = row.querySelector('.total')?.value || 0;
                        hidden.className = 'hidden-total-price';
                    }

                    row.appendChild(hidden);
                }

                else if (nameBase.startsWith('resource') && isResourceRow) {
                    const hidden = document.createElement('input');
                    hidden.type = 'hidden';
                    hidden.name = nameBase;

                    if (nameBase.includes('Quantity')) {
                        hidden.value = row.querySelector('.quantity')?.value || 0;
                        hidden.className = 'hidden-quantity';

                    } else if (nameBase.includes('UnitPrice')) {
                        hidden.value = row.querySelector('.unit-price')?.value || 0;
                        hidden.className = 'hidden-unit-price';

                    } else if (nameBase.includes('Total')) {
                        hidden.value = row.querySelector('.total')?.value || 0;
                        hidden.className = 'hidden-total-price';
                    }

                    row.appendChild(hidden);
                }
            }

        });
        syncRowHiddenFields(row);
        updateRowDisplay(row);
    });
}

function setupDrinkDomItem(item) {
    const qtyInput = item.querySelector('input[type="number"]');
    const hiddenQty = item.querySelector('[name^="drinkQuantities"]');
    const removeBtn = item.querySelector('.btn-remove');

    if (qtyInput) {
        qtyInput.addEventListener('input', () => {
            if (hiddenQty) hiddenQty.value = qtyInput.value;
            debounceRefreshAutoIngredients();
        });
    }

    if (removeBtn) {
        removeBtn.addEventListener('click', async () => {
            item.remove();
            await refreshAutoIngredients();
        });
    }
}

document.querySelectorAll('#addedDrinks .added-item').forEach(setupDrinkDomItem);

document.getElementById('addDrinkBtn')?.addEventListener('click', async () => {
    const select = document.getElementById('drinkSelect');
    const id = select?.value;
    const name = select?.selectedOptions?.[0]?.text || '';
    const qtyVal = document.getElementById('drinkQuantity')?.value;
    const qty = parseFloat(qtyVal);
    if (!id || isNaN(qty) || qty <= 0) return;

    const div = document.createElement('div');
    div.className = "added-item d-flex align-items-center gap-1 mb-1";
    div.innerHTML = `
        <span style="white-space:nowrap;">${name}</span>
        <input type="number" class="drink-quantity form-control form-control-sm" style="width:70px; margin:0 6px;" min="1" value="${qty}">
        <span>un</span>
        <button class="btn-remove btn btn-sm btn-danger" type="button" style="margin-left:auto;">Remover</button>
        <input type="hidden" name="drinkIds" value="${id}">
        <input type="hidden" name="drinkQuantities" value="${qty}">
    `;
    document.getElementById('addedDrinks')?.appendChild(div);
    setupDrinkDomItem(div);

    if (select) select.value = '';
    const dq = document.getElementById('drinkQuantity'); if (dq) dq.value = '';

    await refreshAutoIngredients();
});

let refreshTimeout = null;
function debounceRefreshAutoIngredients() {
    if (refreshTimeout) clearTimeout(refreshTimeout);
    refreshTimeout = setTimeout(() => {
        refreshAutoIngredients().catch(e => console.error(e));
        refreshTimeout = null;
    }, 300);
}

async function refreshAutoIngredients() {
    const ids = [...document.getElementsByName('drinkIds')].map(i => i.value);
    const qtys = [...document.getElementsByName('drinkQuantities')].map(i => parseFloat(i.value || 0));
    const tbody = document.getElementById('autoIngredientsTable');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (ids.length === 0) {
        updateAllTotals();
        return;
    }

    const drinksPayload = ids.map((id, idx) => ({ drinkId: id, quantity: qtys[idx] || 0 }));

    try {
        const res = await fetch('/drink/calculate-ingredients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(drinksPayload)
        });
        if (!res.ok) throw new Error('Erro ao calcular ingredientes');
        const list = await res.json();

        if (!list || list.length === 0) {
            updateAllTotals();
            return;
        }

        list.forEach(i => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${i.ingredientName}</td>
                <td>
                    <div style="display:flex; align-items:center;">
                        <input class="form-control form-control-sm final-quantity" type="number" min="0" step="0.01" value="${i.quantity}">
                        <span style="margin-left:6px;">${i.unitMeasure}</span>
                    </div>
                    <input type="hidden" name="autoIngredientIds" value="${i.ingredientId}">
                    <input type="hidden" name="autoIngredientQuantities" class="hidden-final-quantity" value="${i.quantity}">
                </td>
                <td>
                    <input class="form-control form-control-sm units" type="number" min="0" step="1" value="${i.unitsNeeded}">
                    <input type="hidden" name="autoIngredientUnits" class="hidden-units" value="${i.unitsNeeded}">
                </td>
                <td>
                    <input class="form-control form-control-sm unit-price" type="number" min="0" step="0.01" value="${i.unitPrice || 0}">
                    <input type="hidden" name="autoIngredientUnitPrices" class="hidden-unit-price" value="${i.unitPrice || 0}">
                </td>
                <td>
                    <span class="total-display">R$ 0,00</span>
                    <input class="total" type="hidden" value="0">
                    <input type="hidden" name="autoIngredientTotals" class="hidden-total-price" value="0">
                </td>
                <td>
                    <button class="btn-remove btn btn-sm btn-danger" type="button">Remover</button>
                </td>
            `;
            tbody.appendChild(row);

            const qtyInput = row.querySelector('.final-quantity');
            const unitsInput = row.querySelector('.units');
            const unitPriceInput = row.querySelector('.unit-price');
            const removeBtn = row.querySelector('.btn-remove');

            qtyInput?.addEventListener('blur', async () => {
                const payload = {
                    ingredientId: i.ingredientId,
                    quantity: parseFloat(qtyInput.value || 0),
                    drinks: drinksPayload
                };
                try {
                    const r = await fetch('/drink/update-quantity', {
                        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
                    });
                    const data = await r.json();
                    if (!data.error) {
                        qtyInput.value = parseFloat(data.quantity).toFixed(2);
                        if (unitsInput) unitsInput.value = data.units;
                        const hiddenUnits = row.querySelector('.hidden-units'); if (hiddenUnits) hiddenUnits.value = data.units;
                        const hiddenFinal = row.querySelector('.hidden-final-quantity') || row.querySelector('[name^="autoIngredientQuantities"]');
                        if (hiddenFinal) hiddenFinal.value = data.quantity;
                        updateRowDisplay(row);
                    }
                } catch (e) { console.error(e); }
            });

            unitsInput?.addEventListener('blur', async () => {
                const payload = {
                    ingredientId: i.ingredientId,
                    units: parseInt(unitsInput.value || 0),
                    drinks: drinksPayload
                };
                try {
                    const r = await fetch('/drink/update-units', {
                        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
                    });
                    const data = await r.json();
                    if (!data.error) {
                        qtyInput.value = parseFloat(data.quantity).toFixed(2);
                        unitsInput.value = data.units;
                        const hiddenFinal = row.querySelector('.hidden-final-quantity') || row.querySelector('[name^="autoIngredientQuantities"]'); if (hiddenFinal) hiddenFinal.value = data.quantity;
                        updateRowDisplay(row);
                    }
                } catch (e) { console.error(e); }
            });

            unitPriceInput?.addEventListener('input', () => updateRowDisplay(row));

            removeBtn?.addEventListener('click', () => {
                row.remove();
                updateAllTotals();
            });

            syncRowHiddenFields(row);
            updateRowDisplay(row);
        });
    } catch (e) {
        console.error('Erro refreshAutoIngredients:', e);
    }

    updateAllTotals();
}

document.getElementById('addManualIngredientBtn')?.addEventListener('click', async () => {
    const ingredientId = Number(document.getElementById('manualIngredientSelect')?.value);
    const quantity = parseFloat(document.getElementById('manualIngredientQuantity')?.value || 0);
    const unitPrice = parseFloat(document.getElementById('manualIngredientUnitPrice')?.value || 0);
    if (!ingredientId || isNaN(quantity)) return;

    const payload = { ingredientId, quantity, unitPrice };
    try {
        const res = await fetch('/budget/manual-ingredient/calculate', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Erro ao calcular ingrediente manual');
        const data = await res.json();

        const tbody = document.getElementById('manualIngredientsTable');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${data.ingredientName}</td>
            <td>
                <div style="display:flex; align-items:center;">
                    <input class="form-control form-control-sm final-quantity" type="number" min="0" step="0.01" value="${data.quantity}">
                    <span style="margin-left:6px;">${data.unitMeasure}</span>
                </div>
                <input type="hidden" name="manualIngredientIds" value="${data.ingredientId}">
                <input type="hidden" name="manualIngredientQuantities" class="hidden-final-quantity" value="${data.quantity}">
            </td>
            <td>
                <input class="form-control form-control-sm units" type="number" min="0" step="1" value="${data.unitsNeeded}">
                <input type="hidden" name="manualIngredientUnits" class="hidden-units" value="${data.unitsNeeded}">
            </td>
            <td>
                <input class="form-control form-control-sm unit-price" type="number" min="0" step="0.01" value="${data.unitPrice || 0}">
                <input type="hidden" name="manualIngredientUnitPrices" class="hidden-unit-price" value="${data.unitPrice || 0}">
            </td>
            <td>
                <span class="total-display">${formatBRL(data.totalPrice)}</span>
                <input class="total" type="hidden" value="${data.totalPrice}">
                <input type="hidden" name="manualIngredientTotals" class="hidden-total-price" value="${data.totalPrice}">
            </td>
            <td>
                <button class="btn-remove btn btn-sm btn-danger" type="button">Remover</button>
            </td>
        `;
        tbody.appendChild(row);

        setupExistingRows('manualIngredientsTable', false);

        document.getElementById('manualIngredientSelect').value = '';
        document.getElementById('manualIngredientQuantity').value = '';
        document.getElementById('manualIngredientUnitPrice').value = '';
    } catch (e) {
        console.error('Erro add manual ingredient:', e);
    }
});

document.getElementById('addResourceBtn')?.addEventListener('click', () => {
    const resourceId = document.getElementById('resourceSelect')?.value;
    const quantity = parseFloat(document.getElementById('resourceQuantity')?.value || 0);
    const unitPrice = parseFloat(document.getElementById('resourceUnitPrice')?.value || 0);
    if (!resourceId || isNaN(quantity)) return;

    const resourceName = document.getElementById('resourceSelect').selectedOptions[0]?.text || 'Recurso';
    const total = quantity * unitPrice;
    const tbody = document.getElementById('resourcesTable');
    const row = document.createElement('tr');

    row.innerHTML = `
        <td>${resourceName}</td>
        <td>
            <input class="form-control form-control-sm quantity" type="number" min="0" step="0.01" value="${quantity}">
            <input type="hidden" name="resourceIds" value="${resourceId}">
            <input type="hidden" name="resourceQuantities" class="hidden-quantity" value="${quantity}">
        </td>
        <td>
            <input class="form-control form-control-sm unit-price" type="number" min="0" step="0.01" value="${unitPrice}">
            <input type="hidden" name="resourceUnitPrices" class="hidden-unit-price" value="${unitPrice}">
        </td>
        <td>
            <span class="total-display">${formatBRL(total)}</span>
            <input class="total" type="hidden" value="${total}">
            <input type="hidden" name="resourceTotals" class="hidden-total-price" value="${total}">
        </td>
        <td>
            <button class="btn-remove btn btn-sm btn-danger" type="button">Remover</button>
        </td>
    `;
    tbody.appendChild(row);

    setupExistingRows('resourcesTable', false);

    document.getElementById('resourceSelect').value = '';
    document.getElementById('resourceQuantity').value = '';
    document.getElementById('resourceUnitPrice').value = '';

});

document.getElementById('restoreProportionBtn')?.addEventListener('click', () => {
    refreshAutoIngredients();
});

document.querySelector('form')?.addEventListener('submit', () => {
    document.querySelectorAll('input').forEach(i => i.blur());
    ['autoIngredientsTable','manualIngredientsTable','resourcesTable'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.querySelectorAll('tr').forEach(r => syncRowHiddenFields(r));
    });
});

const observer = new MutationObserver(updateAllTotals);
['autoIngredientsTable','manualIngredientsTable','resourcesTable'].forEach(id => {
    const el = document.getElementById(id);
    if (el) observer.observe(el, { childList: true, subtree: true });
});

setupExistingRows('autoIngredientsTable', true);
setupExistingRows('manualIngredientsTable', false);
setupExistingRows('resourcesTable', false);

updateAllTotals();
</script>

</body>
</html>