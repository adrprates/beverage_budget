<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Criar Orçamento</title>
    <link rel="stylesheet" th:href="@{/budget/save.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-dark text-light">

<div class="container py-5">
    <div class="card shadow-lg bg-secondary text-light p-4">
        <h2 class="card-title mb-4 text-center">Novo Orçamento</h2>

        <form th:action="@{/budget/save}" method="post">

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="name" class="form-label">Nome do orçamento</label>
                    <input type="text" id="name" name="name" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <label for="peopleCount" class="form-label">Qtd. de pessoas</label>
                    <input type="number" id="peopleCount" name="peopleCount" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <label for="markupPercentage" class="form-label">Markup (%)</label>
                    <input type="number" id="markupPercentage" name="markupPercentage" step="0.01" class="form-control" value="0">
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <label for="eventDate" class="form-label">Data do evento</label>
                    <input type="date" id="eventDate" name="eventDate" class="form-control">
                </div>
                <div class="col-md-6">
                    <label for="eventHour" class="form-label">Hora do evento</label>
                    <input type="time" id="eventHour" name="eventHour" class="form-control">
                </div>
            </div>

            <hr>

            <h5 class="card-title mb-3">Drinks</h5>
            <div class="row mb-3 align-items-center">
                <div class="col-md-6">
                    <select id="drinkSelect" class="form-select">
                        <option value="">Selecione um drink</option>
                        <option th:each="d : ${allDrinks}" th:value="${d.id}" th:text="${d.name}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" id="drinkQuantity" placeholder="Qtd." class="form-control">
                </div>
                <div class="col-md-3">
                    <button type="button" id="addDrinkBtn" class="btn btn-outline-light w-100">Adicionar</button>
                </div>
            </div>

            <div id="addedDrinks" class="mb-4"></div>

            <hr>

            <h5 class="card-title mb-3">Ingredientes</h5>

            <div class="d-flex align-items-center mb-3">
                <div class="form-check me-3">
                    <input class="form-check-input" type="checkbox" id="autoProportion" name="autoProportion">
                    <label class="form-check-label" for="autoProportion">
                        Aplicar proporção automática
                    </label>
                </div>
                <button type="button" id="calcProportionBtn" class="btn btn-outline-light btn-sm">
                    Calcular proporcionalidade
                </button>
            </div>

            <div id="autoIngredientsSection" class="mb-4">
                <h6 class="mb-3">Ingredientes dos Drinks Selecionados</h6>
                <table class="table table-sm table-dark align-middle text-center">
                    <thead>
                    <tr>
                        <th>Ingrediente</th>
                        <th>Quantidade</th>
                        <th>Valor Unit.</th>
                        <th>Total</th>
                    </tr>
                    </thead>
                    <tbody id="autoIngredientsTable"></tbody>
                    <tfoot>
                    <tr>
                        <th colspan="3" class="text-end">Subtotal</th>
                        <th id="autoIngredientsSubtotal">R$ 0,00</th>
                    </tr>
                    </tfoot>
                </table>
            </div>

            <div class="mb-4">
                <h6 class="mb-3">Ingredientes Manuais</h6>
                <div class="row mb-3 align-items-center">
                    <div class="col-md-4">
                        <select id="ingredientSelect" class="form-select">
                            <option value="">Selecione o ingrediente</option>
                            <option th:each="i : ${allIngredients}" th:value="${i.id}" th:text="${i.name}"></option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="number" id="ingredientQuantity" placeholder="Qtd." class="form-control">
                    </div>
                    <div class="col-md-3">
                        <input type="number" id="ingredientUnitPrice" placeholder="Preço unitário" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <button type="button" id="addIngredientBtn" class="btn btn-outline-light w-100">Adicionar</button>
                    </div>
                </div>

                <div id="addedIngredients" class="added-ingredients"></div>
            </div>

            <hr>

            <h5 class="card-title mb-3">Recursos</h5>
            <div class="row mb-3 align-items-center">
                <div class="col-md-5">
                    <select id="resourceSelect" class="form-select">
                        <option value="">Selecione o recurso</option>
                        <option th:each="r : ${allResources}" th:value="${r.id}" th:text="${r.name}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" id="resourceQuantity" placeholder="Qtd." class="form-control">
                </div>
                <div class="col-md-2">
                    <input type="number" id="resourceUnitPrice" placeholder="Preço" class="form-control">
                </div>
                <div class="col-md-2">
                    <button type="button" id="addResourceBtn" class="btn btn-outline-light w-100">Adicionar</button>
                </div>
            </div>

            <div id="addedResources" class="mb-4"></div>

            <hr>

            <div class="text-end mb-4">
                <h6>Subtotal ingredientes: <span id="ingredientTotalDisplay">R$ 0,00</span></h6>
                <h6>Subtotal recursos: <span id="resourceTotalDisplay">R$ 0,00</span></h6>
                <h6>Markup: <span id="markupValueDisplay">R$ 0,00</span></h6>
                <hr>
                <h5>Total custo: <span id="totalCostDisplay">R$ 0,00</span></h5>
                <h4 class="text-success">Preço final: <span id="finalPriceDisplay">R$ 0,00</span></h4>
                <div class="mt-2">
                    <label for="customFinalValue" class="form-label">Valor personalizado (opcional)</label>
                    <input type="number" id="customFinalValue" name="customFinalValue" step="0.01" class="form-control d-inline-block w-auto text-end" placeholder="R$">
                </div>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-success px-5">Salvar Orçamento</button>
                <a th:href="@{/budget/list}" class="btn btn-outline-light px-5">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
function formatCurrency(value) {
    return `R$ ${parseFloat(value || 0).toFixed(2).replace('.', ',')}`;
}

function updateTotals() {
    let ingredientTotal = 0;
    document.querySelectorAll('#autoIngredientsTable .total').forEach(i => ingredientTotal += parseFloat(i.value || 0));
    document.querySelectorAll('#addedIngredients input[name="ingredientUnitPrices"]').forEach((price, idx) => {
        const qty = document.querySelectorAll('#addedIngredients input[name="ingredientQuantities"]')[idx];
        ingredientTotal += parseFloat(price.value || 0) * parseFloat(qty.value || 0);
    });

    let resourceTotal = 0;
    document.querySelectorAll('#addedResources input[name="resourceUnitPrices"]').forEach((price, idx) => {
        const qty = document.querySelectorAll('#addedResources input[name="resourceQuantities"]')[idx];
        resourceTotal += parseFloat(price.value || 0) * parseFloat(qty.value || 0);
    });

    const totalCost = ingredientTotal + resourceTotal;
    const markupPerc = parseFloat(document.getElementById('markupPercentage').value || 0);
    const markupValue = totalCost * (markupPerc / 100);
    const finalPrice = parseFloat(document.getElementById('customFinalValue').value || (totalCost + markupValue));

    document.getElementById('ingredientTotalDisplay').innerText = formatCurrency(ingredientTotal);
    document.getElementById('resourceTotalDisplay').innerText = formatCurrency(resourceTotal);
    document.getElementById('totalCostDisplay').innerText = formatCurrency(totalCost);
    document.getElementById('markupValueDisplay').innerText = formatCurrency(markupValue);
    document.getElementById('finalPriceDisplay').innerText = formatCurrency(finalPrice);
}

document.getElementById('addDrinkBtn').addEventListener('click', async () => {
    const drinkSelect = document.getElementById('drinkSelect');
    const id = drinkSelect.value;
    const name = drinkSelect.selectedOptions[0]?.text;
    const qty = document.getElementById('drinkQuantity').value;
    if (!id || !qty) return;

    const div = document.createElement('div');
    div.className = 'added-item';
    div.innerHTML = `
        ${name} - ${qty} un 
        <button type="button" class="btn-remove">Remover</button>
        <input type="hidden" name="drinkIds" value="${id}">
        <input type="hidden" name="drinkQuantities" value="${qty}">
    `;
    document.getElementById('addedDrinks').appendChild(div);
    div.querySelector('.btn-remove').addEventListener('click', () => { div.remove(); refreshAutoIngredients(); });

    drinkSelect.value = '';
    document.getElementById('drinkQuantity').value = '';
    await refreshAutoIngredients();
});

async function refreshAutoIngredients() {
    const drinkIds = Array.from(document.getElementsByName('drinkIds')).map(i => i.value);
    const tableBody = document.getElementById('autoIngredientsTable');
    tableBody.innerHTML = '';
    const merged = {};

    for (const id of drinkIds) {
        try {
            const res = await fetch(`/drink/${id}/ingredients`);
            if (!res.ok) continue;
            const list = await res.json();
            console.log(`Ingredientes recebidos do drink ${id}:`, list);

            list.forEach(ing => {
                const ingId = ing.ingredientId;
                const name = ing.ingredientName ?? 'Sem nome';
                const qty = parseFloat(ing.quantity ?? 0);
                const unit = ing.unitMeasure ?? '';

                if (!merged[ingId]) {
                    merged[ingId] = { id: ingId, name, quantity: qty, unit };
                } else {
                    merged[ingId].quantity += qty;
                }
            });
        } catch (err) {
            console.error(`Erro ao carregar ingredientes do drink ${id}:`, err);
        }
    }

    Object.values(merged).forEach(i => {
        const qty = parseFloat(i.quantity ?? 0);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${i.name} (${i.unit})<input type="hidden" name="ingredientIds" value="${i.id}"></td>
          <td><input type="number" name="ingredientQuantities" value="${qty}" min="0" step="0.01" class="form-control form-control-sm qty"></td>
          <td><input type="number" name="ingredientUnitPrices" value="0" min="0" step="0.01" class="form-control form-control-sm unit-price"></td>
          <td><span class="total-display">R$ 0,00</span><input type="hidden" class="total" value="0"></td>
        `;
        tableBody.appendChild(row);
        row.querySelectorAll('.qty, .unit-price').forEach(inp =>
            inp.addEventListener('input', () => updateRowTotal(row))
        );
    });

    updateTotals();
}

function updateRowTotal(row) {
    const qty = parseFloat(row.querySelector('.qty').value || 0);
    const unit = parseFloat(row.querySelector('.unit-price').value || 0);
    const total = qty * unit;
    row.querySelector('.total').value = total;
    row.querySelector('.total-display').innerText = formatCurrency(total);
    updateTotals();
}

document.getElementById('calcProportionBtn').addEventListener('click', () => {
    const peopleCount = parseFloat(document.getElementById('peopleCount').value || 0);
    if (!peopleCount) return alert("Informe a quantidade de pessoas para calcular a proporcionalidade.");

    document.querySelectorAll('#autoIngredientsTable tr').forEach(row => {
        const qtyInput = row.querySelector('.qty');
        const baseQty = parseFloat(qtyInput.dataset.baseQty || qtyInput.value || 0);
        if (!qtyInput.dataset.baseQty) qtyInput.dataset.baseQty = baseQty;

        const proportionalQty = baseQty * (peopleCount / 10);
        qtyInput.value = proportionalQty.toFixed(2);
        updateRowTotal(row);
    });
});

document.getElementById('addIngredientBtn').addEventListener('click', () => {
    const id = document.getElementById('ingredientSelect').value;
    const name = document.getElementById('ingredientSelect').selectedOptions[0]?.text;
    const qty = document.getElementById('ingredientQuantity').value;
    const price = document.getElementById('ingredientUnitPrice').value;
    if (!id || !qty) return;

    const div = document.createElement('div');
    div.className = 'added-item';
    div.innerHTML = `
        ${name} - ${qty} un - R$${parseFloat(price || 0).toFixed(2)}
        <button type="button" class="btn-remove">Remover</button>
        <input type="hidden" name="ingredientIds" value="${id}">
        <input type="hidden" name="ingredientQuantities" value="${qty}">
        <input type="hidden" name="ingredientUnitPrices" value="${price}">
    `;
    document.getElementById('addedIngredients').appendChild(div);
    div.querySelector('.btn-remove').addEventListener('click', () => { div.remove(); updateTotals(); });
    updateTotals();
});

document.getElementById('addResourceBtn').addEventListener('click', () => {
    const id = document.getElementById('resourceSelect').value;
    const name = document.getElementById('resourceSelect').selectedOptions[0]?.text;
    const qty = document.getElementById('resourceQuantity').value;
    const price = document.getElementById('resourceUnitPrice').value;
    if (!id || !qty) return;

    const div = document.createElement('div');
    div.className = 'added-item';
    div.innerHTML = `
        ${name} - ${qty} un - R$${price}
        <button type="button" class="btn-remove">Remover</button>
        <input type="hidden" name="resourceIds" value="${id}">
        <input type="hidden" name="resourceQuantities" value="${qty}">
        <input type="hidden" name="resourceUnitPrices" value="${price}">
    `;
    document.getElementById('addedResources').appendChild(div);
    div.querySelector('.btn-remove').addEventListener('click', () => { div.remove(); updateTotals(); });
    updateTotals();
});

document.getElementById('markupPercentage').addEventListener('input', updateTotals);
document.getElementById('customFinalValue').addEventListener('input', updateTotals);
</script>

</body>
</html>