<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Criar Orçamento</title>
    <link rel="stylesheet" th:href="@{/budget/save.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-expand-lg bg-white border-bottom">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/}">Prates Bar</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="menu">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" th:href="@{/ingredient}">Ingredientes</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/drink}">Drinks</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/resource}">Recursos</a></li>
                <li class="nav-item"><a class="nav-link active" th:href="@{/budget}">Orçamentos</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container py-5">
    <div class="card">
        <h2 class="card-title mb-4 text-center">Novo Orçamento</h2>

        <form th:action="@{/budget/save}" method="post">

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="name" class="form-label">Nome do orçamento</label>
                    <input type="text" id="name" name="name" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <label for="peopleCount" class="form-label">Qtd. de pessoas</label>
                    <input type="number" id="peopleCount" name="peopleCount" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <label for="markupPercentage" class="form-label">Markup (%)</label>
                    <input type="number" id="markupPercentage" name="markupPercentage" step="0.01" class="form-control" value="0">
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <label for="eventDate" class="form-label">Data do evento</label>
                    <input type="date" id="eventDate" name="eventDate" class="form-control">
                </div>
                <div class="col-md-6">
                    <label for="eventHour" class="form-label">Hora do evento</label>
                    <input type="time" id="eventHour" name="eventHour" class="form-control">
                </div>
            </div>

            <hr>

            <h5 class="mb-3">Drinks</h5>
            <div class="row mb-3 align-items-center">
                <div class="col-md-6">
                    <select id="drinkSelect" class="form-select">
                        <option value="">Selecione um drink</option>
                        <option th:each="d : ${allDrinks}" th:value="${d.id}" th:text="${d.name}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" id="drinkQuantity" placeholder="Qtd." class="form-control">
                </div>
                <div class="col-md-3">
                    <button type="button" id="addDrinkBtn" class="btn btn-primary w-100">Adicionar</button>
                </div>
            </div>

            <div id="addedDrinks"></div>

            <hr>

            <h5 class="mb-3">Ingredientes dos Drinks Selecionados</h5>

            <button type="button" id="restoreProportionBtn" class="btn btn-secondary btn-sm mb-2">
                Restaurar Proporção
            </button>

            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Ingrediente</th>
                        <th>Quantidade</th>
                        <th>Unidade(s)</th>
                        <th>Valor Unit.</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="autoIngredientsTable"></tbody>
                <tfoot>
                    <tr>
                        <th colspan="4" class="text-end">Subtotal Ingredientes de Drinks</th>
                        <th id="autoIngredientsSubtotal">R$ 0,00</th>
                    </tr>
                </tfoot>
            </table>

            <hr>

            <h5 class="mb-3">Ingredientes Manuais</h5>
            <div class="row mb-3 align-items-center">
                <div class="col-md-4">
                    <select id="manualIngredientSelect" class="form-select">
                        <option value="">Selecione o ingrediente</option>
                        <option th:each="i : ${allIngredients}" th:value="${i.id}" th:text="${i.name}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="number" id="manualIngredientQuantity" placeholder="Qtd." class="form-control">
                </div>
                <div class="col-md-3">
                    <input type="number" id="manualIngredientUnitPrice" placeholder="Preço Unit." class="form-control">
                </div>
                <div class="col-md-2">
                    <button type="button" id="addManualIngredientBtn" class="btn btn-primary w-100">Adicionar</button>
                </div>
            </div>

            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Ingrediente</th>
                        <th>Quantidade</th>
                        <th>Unidades</th>
                        <th>Valor Unit.</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="manualIngredientsTable"></tbody>
                <tfoot>
                    <tr>
                        <th colspan="4" class="text-end">Subtotal Ingredientes Manuais</th>
                        <th id="manualIngredientsSubtotal">R$ 0,00</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>

            <hr>

            <h5 class="mb-3">Recursos</h5>
            <div class="row g-2 mb-3">
                <div class="col-md-4">
                    <label class="form-label">Recurso</label>
                    <select id="resourceSelect" class="form-select">
                        <option value="">Selecione um recurso</option>
                        <th:block th:each="r : ${allResources}">
                            <option th:value="${r.id}" th:text="${r.name}"></option>
                        </th:block>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Quantidade</label>
                    <input id="resourceQuantity" type="number" min="0" step="0.01" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Valor Unitário (R$)</label>
                    <input id="resourceUnitPrice" type="number" min="0" step="0.01" class="form-control">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button id="addResourceBtn" type="button" class="btn btn-primary w-100">Adicionar</button>
                </div>
            </div>

            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Recurso</th>
                        <th>Quantidade</th>
                        <th>Valor Unit.</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="resourcesTable"></tbody>
                <tfoot>
                    <tr>
                        <th colspan="3" class="text-end">Subtotal Recursos</th>
                        <th id="resourceSubtotal">R$ 0,00</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>

            <hr>

            <div class="text-end mb-4">

                <h6>Total Ingredientes de Drinks: <span id="autoIngredientsSubtotalDisplay">R$ 0,00</span></h6>
                <h6>Total Ingredientes Manuais: <span id="manualIngredientsSubtotalDisplay">R$ 0,00</span></h6>
                <h6>Total Recursos: <span id="resourceSubtotalDisplay">R$ 0,00</span></h6>

                <h6 class="mt-3">Markup: <span id="markupValueDisplay">R$ 0,00</span></h6>

                <hr>

                <h5>Total Custo: <span id="totalCostDisplay">R$ 0,00</span></h5>
                <h4 class="text-success">Preço Final: <span id="finalPriceDisplay">R$ 0,00</span></h4>

                <div class="mt-2">
                    <label for="customFinalValue" class="form-label">Valor personalizado (opcional)</label>
                    <input type="number" id="customFinalValue" name="customFinalValue"
                           step="0.01"
                           class="form-control w-auto d-inline-block text-end"
                           placeholder="R$">
                </div>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-primary px-5">Salvar Orçamento</button>
                <a th:href="@{/budget}" class="btn btn-secondary px-5">Cancelar</a>
            </div>

        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
function formatCurrency(value) {
    return `R$ ${parseFloat(value || 0).toFixed(2).replace('.', ',')}`;
}

function updateTotals() {
    let total = 0;

    document.querySelectorAll('#autoIngredientsTable .total, #manualIngredientsTable .total')
        .forEach(input => {
            total += parseFloat(input.value || 0);
        });

    document.getElementById('ingredientTotalDisplay').innerText = formatCurrency(total);
}

function updateRowTotal(row) {
    const units = parseFloat(row.querySelector('.units').value || 0);
    const price = parseFloat(row.querySelector('.unit-price').value || 0);
    const total = units * price;

    row.querySelector('.total').value = total;
    row.querySelector('.total-display').innerText = formatCurrency(total);

    row.querySelector('.hidden-unit-price').value = price;
    row.querySelector('.hidden-total-price').value = total;

    updateTotals();
}

document.getElementById('addDrinkBtn').addEventListener('click', async () => {
    const select = document.getElementById('drinkSelect');
    const id = select.value;
    const name = select.selectedOptions[0]?.text;
    const qty = parseFloat(document.getElementById('drinkQuantity').value);
    if (!id || !qty) return;

    const div = document.createElement('div');
    div.className = "added-item";
    div.innerHTML = `
        ${name} - ${qty} un
        <button class="btn-remove" type="button">Remover</button>
        <input type="hidden" name="drinkIds" value="${id}">
        <input type="hidden" name="drinkQuantities" value="${qty}">
    `;
    document.getElementById('addedDrinks').appendChild(div);

    div.querySelector('.btn-remove').addEventListener('click', () => {
        div.remove();
        refreshAutoIngredients();
    });

    select.value = "";
    document.getElementById('drinkQuantity').value = "";

    await refreshAutoIngredients();
});

async function refreshAutoIngredients() {
    const ids = [...document.getElementsByName('drinkIds')].map(i => i.value);
    const qtys = [...document.getElementsByName('drinkQuantities')].map(i => parseFloat(i.value));
    const tbody = document.getElementById('autoIngredientsTable');
    tbody.innerHTML = '';

    if (ids.length === 0) {
        updateTotals();
        return;
    }

    const drinksPayload = ids.map((id, idx) => ({ drinkId: id, quantity: qtys[idx] }));

    try {
        const res = await fetch(`/drink/calculate-ingredients`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(drinksPayload)
        });
        if (!res.ok) throw new Error('Erro ao calcular ingredientes');

        const list = await res.json();
        if (!list || list.length === 0) {
            updateTotals();
            return;
        }

        list.forEach(i => {
            const unitsNeeded = i.unitsNeeded || 0;
            const finalQuantity = parseFloat(i.quantity || 0);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${i.ingredientName}</td>
                <td>
                    <div style="display: flex; align-items: center;">
                        <input class="form-control form-control-sm final-quantity"
                               type="number" min="0" step="0.01"
                               value="${finalQuantity}" style="flex: 1;">
                        <span style="margin-left: 4px;">${i.unitMeasure}</span>
                    </div>
                    <input type="hidden" name="autoIngredientIds" value="${i.ingredientId}">
                    <input type="hidden" name="autoIngredientQuantities" class="hidden-final-quantity" value="${finalQuantity}">
                </td>
                <td>
                    <input class="form-control form-control-sm units"
                           type="number" min="0" step="1"
                           value="${unitsNeeded}">
                    <input type="hidden" name="autoIngredientUnits" class="hidden-units" value="${unitsNeeded}">
                </td>
                <td>
                    <input class="form-control form-control-sm unit-price"
                           type="number" min="0" step="0.01" value="0.00">
                    <input type="hidden" name="autoIngredientUnitPrices" class="hidden-unit-price" value="0">
                </td>
                <td>
                    <span class="total-display">R$ 0,00</span>
                    <input class="total" type="hidden" value="0">
                    <input type="hidden" class="hidden-total-price" value="0">
                </td>
            `;

            tbody.appendChild(row);

            const qtyInput = row.querySelector('.final-quantity');
            const unitsInput = row.querySelector('.units');
            const unitPriceInput = row.querySelector('.unit-price');

            qtyInput.addEventListener('blur', async () => {
                row.querySelector('.hidden-final-quantity').value = qtyInput.value;

                const qty = parseFloat(qtyInput.value || 0);
                const payload = { ingredientId: i.ingredientId, quantity: qty, drinks: drinksPayload };

                const res = await fetch('/drink/update-quantity', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (!data.error) {
                    unitsInput.value = data.units;
                    qtyInput.value = parseFloat(data.quantity).toFixed(2);
                    updateRowTotal(row);
                }
            });

            unitsInput.addEventListener('blur', async () => {
                row.querySelector('.hidden-units').value = unitsInput.value;

                const units = parseInt(unitsInput.value || 0);
                const payload = { ingredientId: i.ingredientId, units, drinks: drinksPayload };

                const res = await fetch('/drink/update-units', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (!data.error) {
                    unitsInput.value = data.units;
                    qtyInput.value = parseFloat(data.quantity).toFixed(2);
                    updateRowTotal(row);
                }
            });

            unitPriceInput.addEventListener('input', () => updateRowTotal(row));
        });
    } catch (error) {
        console.error("Erro:", error);
    }

    updateTotals();

    
}

document.getElementById("restoreProportionBtn").addEventListener("click", () => {
    refreshAutoIngredients();
});

document.getElementById('addManualIngredientBtn').addEventListener('click', async () => {
    const ingredientId = document.getElementById('manualIngredientSelect').value;
    const quantity = parseFloat(document.getElementById('manualIngredientQuantity').value);
    const unitPrice = parseFloat(document.getElementById('manualIngredientUnitPrice').value || 0);

    if (!ingredientId || isNaN(quantity)) return;

    const payload = {
        ingredientId: Number(ingredientId),
        quantity: quantity,
        unitPrice: unitPrice
    };

    try {
        const res = await fetch('/budget/manual-ingredient/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error('Erro ao calcular ingrediente manual');

        const data = await res.json();
        const tbody = document.getElementById('manualIngredientsTable');
        const row = document.createElement('tr');

        row.innerHTML = `
            <td>${data.ingredientName}</td>

            <td>
                <div style="display: flex; align-items: center;">
                    <input class="form-control form-control-sm final-quantity"
                           type="number" min="0" step="0.01" value="${data.quantity}">
                    <span style="margin-left: 4px;">${data.unitMeasure}</span>
                </div>

                <input type="hidden" name="manualIngredientIds" value="${data.ingredientId}">
                <input type="hidden" name="manualIngredientQuantities"
                       class="hidden-final-quantity" value="${data.quantity}">
            </td>

            <td>
                <input class="form-control form-control-sm units"
                       type="number" min="0" step="1" value="${data.unitsNeeded}">
                <input type="hidden" name="manualIngredientUnits"
                       class="hidden-units" value="${data.unitsNeeded}">
            </td>

            <td>
                <input class="form-control form-control-sm unit-price"
                       type="number" min="0" step="0.01" value="${data.unitPrice}">
                <input type="hidden" name="manualIngredientUnitPrices"
                       class="hidden-unit-price" value="${data.unitPrice}">
            </td>

            <td>
                <span class="total-display">${formatCurrency(data.totalPrice)}</span>
                <input class="total" type="hidden" value="${data.totalPrice}">
                <input type="hidden" name="manualIngredientTotals"
                       class="hidden-total-price" value="${data.totalPrice}">
            </td>

            <td>
                <button class="btn-remove" type="button">Remover</button>
            </td>
        `;

        tbody.appendChild(row);

        const qtyInput = row.querySelector('.final-quantity');
        const unitsInput = row.querySelector('.units');
        const unitPriceInput = row.querySelector('.unit-price');
        const btnRemove = row.querySelector('.btn-remove');

        function updateManualRow(row, updated) {
            const qtyInput = row.querySelector('.final-quantity');
            const unitsInput = row.querySelector('.units');
            const unitPriceInput = row.querySelector('.unit-price');

            qtyInput.value = updated.quantity;
            unitsInput.value = updated.unitsNeeded;

            row.querySelector('.hidden-final-quantity').value = updated.quantity;
            row.querySelector('.hidden-units').value = updated.unitsNeeded;

            row.querySelector('.total').value = updated.totalPrice;
            row.querySelector('.hidden-total-price').value = updated.totalPrice;
            row.querySelector('.total-display').innerText = formatCurrency(updated.totalPrice);

            updateTotals();
        }

        qtyInput.addEventListener('blur', async () => {
            const newQty = parseFloat(qtyInput.value);
            if (isNaN(newQty)) return;

            const response = await fetch('/budget/manual-ingredient/calculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ingredientId: data.ingredientId,
                    quantity: newQty,
                    unitPrice: parseFloat(unitPriceInput.value || 0)
                })
            });

            if (!response.ok) return;
            const updated = await response.json();
            updateManualRow(row, updated);
        });

        unitsInput.addEventListener('blur', async () => {
            const newUnits = parseInt(unitsInput.value);
            if (isNaN(newUnits)) return;

            const response = await fetch('/budget/manual-ingredient/calculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ingredientId: data.ingredientId,
                    units: newUnits,
                    unitPrice: parseFloat(unitPriceInput.value || 0)
                })
            });

            if (!response.ok) return;
            const updated = await response.json();
            updateManualRow(row, updated);
        });

        unitPriceInput.addEventListener('input', () => {
            const units = parseFloat(unitsInput.value || 0);
            const price = parseFloat(unitPriceInput.value || 0);
            const total = units * price;

            row.querySelector('.total').value = total;
            row.querySelector('.hidden-unit-price').value = price;
            row.querySelector('.hidden-total-price').value = total;
            row.querySelector('.total-display').innerText = formatCurrency(total);

            updateTotals();
        });

        btnRemove.addEventListener('click', () => {
            row.remove();
            updateTotals();
        });

        updateTotals();

        document.getElementById('manualIngredientSelect').value = "";
        document.getElementById('manualIngredientQuantity').value = "";
        document.getElementById('manualIngredientUnitPrice').value = "";

    } catch (error) {
        console.error("Erro ao calcular ingrediente manual:", error);
    }
});


document.getElementById('addResourceBtn').addEventListener('click', () => {
    const resourceId = document.getElementById('resourceSelect').value;
    const quantity = parseFloat(document.getElementById('resourceQuantity').value);
    const unitPrice = parseFloat(document.getElementById('resourceUnitPrice').value || 0);

    if (!resourceId || isNaN(quantity)) return;

    const resourceName = document.getElementById('resourceSelect')
                                .selectedOptions[0].text;

    const total = quantity * unitPrice;

    const tbody = document.getElementById('resourcesTable');
    const row = document.createElement('tr');

    row.innerHTML = `
        <td>${resourceName}</td>

        <td>
            <input class="form-control form-control-sm quantity"
                   type="number" min="0" step="0.01" value="${quantity}">
            <input type="hidden" name="resourceIds" value="${resourceId}">
            <input type="hidden" name="resourceQuantities"
                   class="hidden-quantity" value="${quantity}">
        </td>

        <td>
            <input class="form-control form-control-sm unit-price"
                   type="number" min="0" step="0.01" value="${unitPrice}">
            <input type="hidden" name="resourceUnitPrices"
                   class="hidden-unit-price" value="${unitPrice}">
        </td>

        <td>
            <span class="total-display">${formatCurrency(total)}</span>
            <input class="total" type="hidden" value="${total}">
            <input type="hidden" name="resourceTotals"
                   class="hidden-total-price" value="${total}">
        </td>

        <td>
            <button class="btn-remove" type="button">Remover</button>
        </td>
    `;

    tbody.appendChild(row);

    const qtyInput = row.querySelector('.quantity');
    const unitPriceInput = row.querySelector('.unit-price');
    const btnRemove = row.querySelector('.btn-remove');

    function recalc() {
        const q = parseFloat(qtyInput.value || 0);
        const p = parseFloat(unitPriceInput.value || 0);
        const t = q * p;

        row.querySelector('.total').value = t;
        row.querySelector('.total-display').innerText = formatCurrency(t);

        row.querySelector('.hidden-quantity').value = q;
        row.querySelector('.hidden-unit-price').value = p;
        row.querySelector('.hidden-total-price').value = t;

        updateTotals();
    }

    qtyInput.addEventListener('input', recalc);
    unitPriceInput.addEventListener('input', recalc);

    btnRemove.addEventListener('click', () => {
        row.remove();
        updateTotals();
    });

    updateTotals();

    document.getElementById('resourceSelect').value = "";
    document.getElementById('resourceQuantity').value = "";
    document.getElementById('resourceUnitPrice').value = "";
});

document.querySelector('form').addEventListener('submit', () => {
        document.querySelectorAll('input').forEach(input => input.blur());
});

function formatCurrency(value) {
    return `R$ ${parseFloat(value || 0)
        .toFixed(2)
        .replace('.', ',')}`;
}

function calculateSubtotal(tableId) {
    let total = 0;

    const table = document.getElementById(tableId);
    if (!table) return 0;

    table.querySelectorAll(".total").forEach(input => {
        total += parseFloat(input.value || 0);
    });

    return total;
}

function updateTotals() {
    const autoTotal = calculateSubtotal("autoIngredientsTable");
    const manualTotal = calculateSubtotal("manualIngredientsTable");
    const resourceTotal = calculateSubtotal("resourcesTable");

    setText("autoIngredientsSubtotal", autoTotal);
    setText("manualIngredientsSubtotal", manualTotal);
    setText("resourceSubtotal", resourceTotal);

    setText("autoIngredientsSubtotalDisplay", autoTotal);
    setText("manualIngredientsSubtotalDisplay", manualTotal);
    setText("resourceSubtotalDisplay", resourceTotal);

    const ingredientsTotal = autoTotal + manualTotal;

    const markupPercent = parseFloat(document.getElementById("markupPercentage")?.value || 0);
    const markupValue = (ingredientsTotal + resourceTotal) * (markupPercent / 100);
    setText("markupValueDisplay", markupValue);

    const totalCost = ingredientsTotal + resourceTotal + markupValue;
    setText("totalCostDisplay", totalCost);

    const custom = parseFloat(document.getElementById("customFinalValue")?.value || 0);
    setText("finalPriceDisplay", custom > 0 ? custom : totalCost);
}

function setText(id, value) {
    const el = document.getElementById(id);
    if (!el) return;

    el.innerText = value.toLocaleString("pt-BR", {
        style: "currency",
        currency: "BRL"
    });
}

const observer = new MutationObserver(updateTotals);

["autoIngredientsTable", "manualIngredientsTable", "resourcesTable"]
    .forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            observer.observe(el, { childList: true, subtree: true });
        }
    });

document.addEventListener("input", updateTotals);

updateTotals();

</script>

</body>
</html>