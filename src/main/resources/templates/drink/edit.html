<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prates Bar - Editar Drink</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" th:href="@{/drink/save.css}">
  <style>
    #ingredientSuggestions { 
      max-height: 150px; 
      overflow-y: auto; 
      margin-top: 5px; 
      position: absolute; 
      z-index: 10; 
      width: 100%; 
    }

    #ingredientSuggestions li {
      font-weight: bold;         
      color: black;              
      background-color: white;  
      cursor: pointer;           
      padding: 5px 10px;
      list-style: none;
      border-bottom: 1px solid #ccc;
    }

    #ingredientSuggestions li:hover {
      background-color: #e0e0e0; 
    }

    .ingredient-selector { 
      display: flex; 
      gap: 10px; 
      flex-wrap: wrap; 
    }

    .ingredient-selector input, .ingredient-selector select { 
      flex: 1; 
      min-width: 150px; 
    }

    .added-ingredient-item { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 5px 10px; 
      background: #2a2a2a; 
      margin-bottom: 5px; 
      border-radius: 5px; 
      color: #fff; 
    }

    .btn-remove { 
      background: none; 
      border: none; 
      color: #ff6b6b; 
      cursor: pointer; 
    }

    .btn-remove:hover { 
      color: #ff3b3b; 
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark custom-navbar fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold d-flex align-items-center" th:href="@{/}">
      <i class="bi bi-stars me-2"></i> Prates Bar
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menu">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="menu">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" th:href="@{/ingredient}"><i class="bi bi-box-seam"></i> Ingredientes</a></li>
        <li class="nav-item"><a class="nav-link" th:href="@{/drink}"><i class="bi bi-cup-straw"></i> Drinks</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-people"></i> Proporções</a></li>
        <li class="nav-item"><a class="nav-link" th:href="@{/resource}"><i class="bi bi-stars"></i> Recursos</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-cash-coin"></i> Orçamentos</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container dashboard-container">
  <h1 class="text-center mb-4">
    <span style="color:#ffffff;">Editar</span> <span class="highlight">Drink</span>
  </h1>

  <div class="card dashboard-card mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">Informações do Drink</h5>

      <form th:action="@{/drink/update}" th:object="${drink}" method="post">
        <input type="hidden" th:field="*{id}">

        <div class="mb-3">
          <label class="form-label">Nome do Drink</label>
          <input type="text" th:field="*{name}" class="form-control" placeholder="Ex: Caipirinha" required>
          <div class="text-danger" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
        </div>

        <div class="mb-3">
          <label class="form-label">Quantidade Total</label>
          <input type="number" th:field="*{quantity}" class="form-control" placeholder="Ex: 500" required>
          <div class="text-danger" th:if="${#fields.hasErrors('quantity')}" th:errors="*{quantity}"></div>
        </div>

        <div class="mb-3">
          <label class="form-label">Unidade de Medida</label>
          <select th:field="*{unitMeasure.id}" class="form-select" required>
            <option value="">Selecione a unidade</option>
            <option th:each="u : ${allUnits}" th:value="${u.id}" th:text="${u.description}" 
                    th:selected="${drink.unitMeasure != null} ? ${u.id == drink.unitMeasure.id} : false">
            </option>
          </select>
          <div class="text-danger" th:if="${#fields.hasErrors('unitMeasure')}" th:errors="*{unitMeasure}"></div>
        </div>

        <div class="mb-3">
          <label class="form-label">Porções</label>
          <input type="number" th:field="*{servings}" class="form-control" placeholder="Ex: 5" required>
          <div class="text-danger" th:if="${#fields.hasErrors('servings')}" th:errors="*{servings}"></div>
        </div>

        <div class="mb-3">
          <label class="form-label">Descrição</label>
          <textarea th:field="*{description}" class="form-control" rows="3"></textarea>
        </div>

        <hr>
        <h5 class="card-title mb-3">Ingredientes</h5>

        <div class="mb-3">
          <label for="ingredientSearch" class="form-label">Adicionar Ingrediente</label>
          <div class="ingredient-selector">
            <input type="text" id="ingredientSearch" placeholder="Digite o nome do ingrediente..." class="form-control">
            <input type="number" id="ingredientQuantity" placeholder="Quantidade" class="form-control">
            <input type="text" id="ingredientUnit" placeholder="Unidade" class="form-control" readonly>
            <button type="button" id="addIngredientBtn" class="btn btn-outline-light btn-card">Adicionar</button>
          </div>
          <ul id="ingredientSuggestions"></ul>
        </div>

        <div class="added-ingredients" id="addedIngredients">
          <div th:each="di : ${drink.ingredients}" class="added-ingredient-item">
            <span th:text="|${di.ingredient.name} - ${di.quantity} ${di.ingredient.unitMeasure.description}|"></span>
            <button type="button" class="btn-remove">Remover</button>
            <input type="hidden" name="ingredientIds" th:value="${di.ingredient.id}">
            <input type="hidden" name="quantities" th:value="${di.quantity}">
          </div>
        </div>

        <div class="text-center mt-4">
          <button type="submit" class="btn btn-outline-light btn-card">Atualizar Drink</button>
          <a th:href="@{/drink}" class="btn btn-secondary ms-2">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script th:inline="javascript">
  const ingredients = /*[[${allIngredients}]]*/ [];

  let selectedIngredient = null;

  const searchInput = document.getElementById('ingredientSearch');
  const suggestionsList = document.getElementById('ingredientSuggestions');
  const quantityInput = document.getElementById('ingredientQuantity');
  const unitInput = document.getElementById('ingredientUnit');
  const addedIngredientsDiv = document.getElementById('addedIngredients');

  function createIngredientItem(ingredient, quantity) {
    const div = document.createElement('div');
    div.className = 'added-ingredient-item';
    div.innerHTML = `
      <span>${ingredient.name} - ${quantity} ${ingredient.unitMeasure.description}</span>
      <button type="button" class="btn-remove">Remover</button>
      <input type="hidden" name="ingredientIds" value="${ingredient.id}">
      <input type="hidden" name="quantities" value="${quantity}">
    `;
    div.querySelector('.btn-remove').addEventListener('click', () => div.remove());
    return div;
  }

  searchInput.addEventListener('keyup', () => {
    const query = searchInput.value.toLowerCase();
    suggestionsList.innerHTML = '';
    if (query.length === 0) return;

    const filtered = ingredients.filter(i => i.name.toLowerCase().includes(query));
    filtered.forEach(i => {
      const li = document.createElement('li');
      li.textContent = i.name;
      li.addEventListener('click', () => {
        selectedIngredient = i;
        searchInput.value = i.name;
        unitInput.value = i.unitMeasure.description;
        suggestionsList.innerHTML = '';
      });
      suggestionsList.appendChild(li);
    });
  });

  document.getElementById('addIngredientBtn').addEventListener('click', () => {
    if (!selectedIngredient || !quantityInput.value) return;

    const item = createIngredientItem(selectedIngredient, quantityInput.value);
    addedIngredientsDiv.appendChild(item);

    searchInput.value = '';
    quantityInput.value = '';
    unitInput.value = '';
    selectedIngredient = null;
  });

  document.querySelectorAll('.added-ingredient-item .btn-remove').forEach(btn => {
    btn.addEventListener('click', () => btn.parentElement.remove());
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>